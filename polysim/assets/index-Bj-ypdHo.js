var et=Object.defineProperty;var st=(i,t,e)=>t in i?et(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var f=(i,t,e)=>(st(i,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const w=Math.abs,D=Math.min,y=Math.max;class h{constructor(t,e){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}mult(t){return this.x*=t,this.y*=t,this}div(t){return this.x/=t,this.y/=t,this}normalize(){return this.mult(1/this.mag()),this.isSingular()&&(this.x=1,this.y=0),this}mag(){return Math.sqrt(this.magSq())}magSq(){return this.x*this.x+this.y*this.y}isSingular(){return!(isFinite(this.x)&&isFinite(this.y))}static sub(t,e){return new h(t.x-e.x,t.y-e.y)}static mult(t,e){return new h(t.x*e,t.y*e)}static dot(t,e){return t.x*e.x+t.y*e.y}static per(t,e){return t.x*e.y-e.x*t.y}static span(t,e){return h.sub(e,t)}static distSq(t,e){const s=t.x-e.x,n=t.y-e.y;return s*s+n*n}}class E{static side(t,e,s){return h.per(h.span(t,e),h.span(t,s))}static intersect(t,e,s,n){const r=h.span(t,e),o=h.span(t,s),c=h.span(t,n),u=h.per(r,o)*h.per(r,c);if(u>0)return!1;const p=h.span(s,n),d=h.span(s,e),a=h.per(p,o)*h.per(p,d);if(a<0)return!1;if(u==0&&a==0){const l=r.magSq();return o.magSq()<=l||c.magSq()<l}return!0}static project(t,e){const s=-(e.a*t.x+e.b*t.y+e.c)/(e.a*e.a+e.b*e.b);return new h(t.x+s*e.a,t.y+s*e.b)}static intersection(t,e){let s=t.a,n=t.b,r=-t.c,o=e.a,c=e.b,u=-e.c,p=!1;if(y(w(s),w(n))<y(w(o),w(c))){let l;l=s,s=o,o=l,l=n,n=c,c=l,l=r,r=u,u=l}if(w(s)<w(n)){let l;l=s,s=n,n=l,l=o,o=c,c=l,p=!0}c-=n*o/s,u-=r*o/s;const d=u/c,a=(r-n*d)/s;return p?new h(d,a):new h(a,d)}}class V{constructor(){f(this,"points",[]);f(this,"listeners",[])}length(){return this.points.length}isEmpty(){return this.points.length===0}point(t){return this.points[t]}lastPoint(){return this.points[this.points.length-1]}addPoint(t){this.points.push(t),this.listeners.forEach(e=>e.onAddPoint(this,t))}addPointc(t,e){this.addPoint(new h(t,e))}clear(){this.points.length=0,this.listeners.forEach(t=>t.onClear(this))}addListener(t){this.listeners.push(t)}[Symbol.iterator](){return this.points[Symbol.iterator]()}}class T{constructor(t,e,s){this.a=t,this.b=e,this.c=s}origin(){const t=this.a,e=this.b,n=-this.c/(t*t+e*e);return new h(t*n,e*n)}tangent(){return new h(-this.b,this.a)}normal(){return new h(this.a,this.b)}map(t){const e=this.a,s=this.b,n=this.c,r=e*e+s*s,o=(e*t.x+s*t.y+n)/r,c=n/r-o,u=w(e)>w(s)?(t.y+s*c)/e:-(t.x+e*c)/s;return new nt(u,o)}unmap(t){return this.unmapc(t.s,t.t)}unmapc(t,e){const s=this.a,n=this.b,r=this.c,o=e-r/(s*s+n*n);return new h(o*s-t*n,o*n+t*s)}remap(t,e){return this.remapc(t,e.s,e.t)}remapc(t,e,s){return this.map(t.unmapc(e,s))}}class nt{constructor(t,e){this.s=t,this.t=e}}class L{constructor(t){f(this,"pathLength",0);f(this,"sumsX",[]);f(this,"sumsY",[]);f(this,"sumsXX",[]);f(this,"sumsYY",[]);f(this,"sumsXY",[]);t.addListener(this),this.onClear(t);for(const e of t)this.onAddPoint(t,e)}onClear(t){this.pathLength=0,this.sumsX.length=0,this.sumsX.push(0),this.sumsY.length=0,this.sumsY.push(0),this.sumsXX.length=0,this.sumsXX.push(0),this.sumsYY.length=0,this.sumsYY.push(0),this.sumsXY.length=0,this.sumsXY.push(0)}onAddPoint(t,e){const s=e.x,n=e.y,r=this.pathLength;this.sumsX.push(this.sumsX[r]+s),this.sumsY.push(this.sumsY[r]+n),this.sumsXX.push(this.sumsXX[r]+s*s),this.sumsYY.push(this.sumsYY[r]+n*n),this.sumsXY.push(this.sumsXY[r]+s*n),++this.pathLength}fitLineWhole(){return this.fitLine(0,this.pathLength-1)}fitLine(t,e){return L.fitLine(L.rangeSum(this.sumsX,t,e),L.rangeSum(this.sumsY,t,e),L.rangeSum(this.sumsXX,t,e),L.rangeSum(this.sumsYY,t,e),L.rangeSum(this.sumsXY,t,e),e-t+1)}static fitLine(t,e,s,n,r,o){if(o<=0)return new T(1,-1,0);const c=y(o*s-t*t,0),u=y(o*n-e*e,0);if(c<=Number.EPSILON&&u<=Number.EPSILON)return new T(-1,-1,(t+e)/o);if(c<u){const d=(t*e-o*r)/u,a=-(e*d+t)/o;return new T(1,d,a)}else{const p=(t*e-o*r)/c,d=1,a=-(t*p+e)/o;return new T(p,d,a)}}static rangeSum(t,e,s){return t[s+1]-t[e]}}class x{constructor(){f(this,"_first");f(this,"_size",0)}static makeNode(t,e,s){const n={pos:t,isValid:!0};return n.prev=e??n,n.next=s??n,n.prev.next=n.next.prev=n,n}get first(){return this._first}size(){return this._size}isEmpty(){return this._size===0}offer(t){var e;if(this._size>=3){const s=this.first;let n=this.first;for(;n.prev!=s&&E.side(n.pos,n.prev.pos,t)>=0;)n=n.prev;let r=s;for(;r.next!=s&&E.side(r.pos,r.next.pos,t)<=0;)r=r.next;if(n!=r){let o=n.next;for(;o!=r;)o.isValid=!1,o=o.next,--this._size;this._first=x.makeNode(t,n,r)}}else if(this._size==0)this._first=x.makeNode(t);else if(this._size==1)this._first=x.makeNode(t,this.first,this.first);else{const s=this.first,n=E.side(s.pos,s.next.pos,t);n<0?this._first=x.makeNode(t,s,s.next):n>0?this._first=x.makeNode(t,s.prev,s):(s.isValid=!1,this._first=x.makeNode(t,s.prev,s.next),--this._size)}if(((e=this.first)==null?void 0:e.pos)===t)return++this._size,this.first}}class B{constructor(t,e){f(this,"path");f(this,"pathLength",0);f(this,"fitter");f(this,"tags",[]);f(this,"thresholdSq");f(this,"trace",[]);this.path=t,this.fitter=new L(t),this.thresholdSq=e*e,t.addListener(this),this.onClear(t);for(const s of t)this.onAddPoint(t,s)}onClear(t){this.pathLength=0,this.tags.length=0}onAddPoint(t,e){this.trace.length=0,this.trace.push("accept");const s=this.pathLength++,n=e,r=new j(this.fitter.fitLine(s,s),n),o=new x,c=o.offer(n);if(s===0){this.tags.push({dist:0,next:-1,cut:!1});return}let u=s-1,p=this.tags[u].dist;for(let d=s-1;d>=0;--d){const a=t.point(d),l=this.tags[d];if(l.cut||d<s-2&&E.intersect(a,t.point(d+1),t.point(s-1),n)){l.cut=!0,this.trace.push("cut");break}const k=this.fitter.fitLine(d,s);if(r.extend(k,a),r.error()>this.thresholdSq){this.trace.push("threshold");break}const W=o.offer(a);if(!W||!B.isPioneer(k,W)){this.trace.push("pioneer_weak");continue}if(!B.isPioneer(k,c)){this.trace.push("pioneer_strong");break}this.trace.push("accept"),l.dist<p&&(u=d,p=l.dist)}this.tags.push({dist:p+1,next:u,cut:!1})}static isPioneer(t,e){if(!e.isValid)return!1;const s=t.tangent(),n=h.dot(s,h.span(e.pos,e.prev.pos)),r=h.dot(s,h.span(e.pos,e.next.pos));return n*r>=0}getSimplified(){if(this.pathLength<=1)return this.path;const t=this.path,e=this.tags,s=this.fitter,n=new V;let r=this.pathLength-1,o=e[r].next,c=s.fitLine(o,r);for(n.addPoint(E.project(t.point(r),c));o!=0;){r=o,o=e[r].next;const u=t.point(r),p=c;c=s.fitLine(o,r);const d=E.intersection(c,p);d.isSingular()||h.distSq(d,u)>4*this.thresholdSq?n.addPoint(u):n.addPoint(d)}return n.addPoint(E.project(t.point(0),c)),n}}class j{constructor(t,e){f(this,"line");f(this,"s0");f(this,"s1");f(this,"t0");f(this,"t1");this.line=t;const s=t.map(e);this.s0=this.s1=s.s,this.t0=this.t1=s.t}extend(t,e){const s=t.map(e),n=t.remapc(this.line,this.s0,this.t0),r=t.remapc(this.line,this.s0,this.t1),o=t.remapc(this.line,this.s1,this.t0),c=t.remapc(this.line,this.s1,this.t1);this.line=t,this.s0=D(s.s,n.s,r.s,o.s,c.s),this.s1=y(s.s,n.s,r.s,o.s,c.s),this.t0=D(s.t,n.t,r.t,o.t,c.t),this.t1=y(s.t,n.t,r.t,o.t,c.t)}error(){const t=this.t0,e=this.t1,s=this.line;return y(t*t,e*e)*(s.a*s.a+s.b*s.b)}getCartesianCorners(){const t=this.line;return[t.unmapc(this.s0,this.t0),t.unmapc(this.s0,this.t1),t.unmapc(this.s1,this.t1),t.unmapc(this.s1,this.t0)]}}const it=13,G=2,U=4,rt=2,ot=2,ct=1,ht=20,at=2,J="#998B6D",K="#3B2969",lt="#36CF72",dt="#FF5D76",ut="#FFF533",ft="#FF5D76",mt=.9;let Q=new h(0,0);const S=4;let q=!1,Z=0,H=0;const m=new V;let b=null,O=null;const F=document.getElementById("show-original-checkbox"),z=document.getElementById("show-simple-checkbox"),pt=document.getElementById("threshold-range-value"),A=document.getElementById("threshold-range"),_=document.getElementById("show-error-box-checkbox"),v=document.getElementById("show-hull-checkbox"),gt=document.getElementById("trace-depth-range"),X="Freehand (F)",M="Sparse (S)",Y="Precise (P)",g=document.getElementById("input-method-button"),xt=document.getElementById("clear-button"),yt=document.getElementById("original-length-stat"),wt=document.getElementById("simple-length-stat"),Lt=document.getElementById("ratio-stat");let I=NaN;const C=document.getElementById("main-canvas"),bt=document.getElementById("main-view"),R=document.getElementById("main-overlay"),P=document.getElementById("detail-canvas"),Et=document.getElementById("detail-view");function $(i,t){i.width!==t.offsetWidth&&(i.width=t.offsetWidth),i.height!==t.offsetHeight&&(i.height=t.offsetHeight)}m.addListener({onClear:i=>{b=null},onAddPoint:(i,t)=>{if(Z=H,b=null,i.length()<2)return;const e=i.point(i.length()-2);Q.add(h.span(e,t).normalize().mult(.05)).div(1.05)}});F.checked=!0;z.checked=!0;A.min=ct.toString();A.max=ht.toString();A.value=at.toString();_.checked=!0;v.checked=!0;g.innerText=X;g.addEventListener("click",()=>{g.innerText===X?g.innerText=M:g.innerText===M?g.innerText=Y:g.innerText=X,m.clear()});xt.addEventListener("click",()=>{m.clear()});function St(){const i=parseFloat(A.value);i!=I&&(I=i,pt.innerHTML=I.toPrecision(3)+"px",O=new B(m,I),b=null),b??(b=O.getSimplified());const t=y(1,b.length())/y(1,m.length());yt.innerHTML=m.length().toString(),wt.innerHTML=b.length().toString(),Lt.innerHTML=Math.round(t*100)+"%"}const kt=C.getContext("2d"),Pt=P.getContext("2d");function tt(i){H=i,St(),Tt(),Ot(),window.requestAnimationFrame(tt)}window.requestAnimationFrame(tt);function Ot(){const i=kt;i.lineJoin="round",$(C,bt),i.clearRect(0,0,C.width,C.height),!m.isEmpty()&&(i.strokeStyle=J,i.lineWidth=G,F.checked&&N(i,m),i.strokeStyle=K,i.lineWidth=U,z.checked&&N(i,b))}function Tt(){const i=Pt;if(i.lineJoin="round",i.resetTransform(),$(P,Et),i.clearRect(0,0,P.width,P.height),m.isEmpty())return;const t=P.width,e=h.mult(Q,mt*t/2);if(i.translate(e.x+t/2,e.y+t/2),i.scale(S,S),i.translate(-m.lastPoint().x,-m.lastPoint().y),i.strokeStyle=J,i.lineWidth=G/S,F.checked&&N(i,m),i.strokeStyle=K,i.lineWidth=U/S,z.checked&&N(i,b),!_.checked&&!v.checked)return;const s=O.trace,n=m.length()-1,r=m.point(n),o=new j(O.fitter.fitLine(n,n),r),c=new x;c.offer(r);const u=Math.round(parseFloat(gt.value)*(s.length-1)),p=s[u],d=p==="cut"?n-u+1:n-u;for(let a=n-1;a>=d;--a){const l=m.point(a);if(_.checked){const k=O.fitter.fitLine(a,n);o.extend(k,l)}v.checked&&c.offer(l)}if(_.checked){const a=o.getCartesianCorners();i.strokeStyle=p!="threshold"?lt:dt,i.lineWidth=rt/S,i.beginPath(),i.moveTo(a[0].x,a[0].y);for(let l=1;l<a.length;++l)i.lineTo(a[l].x,a[l].y);i.closePath(),i.stroke()}if(v.checked){i.strokeStyle=p!=="pioneer_weak"&&p!="pioneer_strong"?ut:ft,i.lineWidth=ot/S;let a=c.first;for(i.beginPath(),i.moveTo(a.pos.x,a.pos.y);a.next!==c.first;)a=a.next,i.lineTo(a.pos.x,a.pos.y);i.closePath(),i.stroke()}}function N(i,t){const e=t.length();if(e<2)return;i.beginPath();const s=t.point(0);i.moveTo(s.x,s.y);for(let n=1;n<e;++n){const r=t.point(n);i.lineTo(r.x,r.y)}i.stroke()}R.addEventListener("mousedown",i=>{i.target===R&&(g.innerText!==Y&&m.clear(),m.addPointc(i.offsetX,i.offsetY),q=!0)});R.addEventListener("mousemove",i=>{if(i.target!==R||!q||g.innerText===Y||g.innerText===M&&it*(H-Z)<1e3)return;const t=new h(Math.round(i.offsetX),Math.round(i.offsetY));if(!m.isEmpty()){const e=m.lastPoint();if(e.x===t.x&&e.y===t.y)return}m.addPoint(t)});window.addEventListener("mouseup",()=>{q=!1});window.addEventListener("keydown",i=>{let t=null;switch(i.key){case"c":case"C":m.clear();break;case"f":case"F":t=X;break;case"p":case"P":t=Y;break;case"s":case"S":t=M;break}t&&g.innerText!==t&&(g.innerText=t,m.clear())});
